# 🎯 Логика работы оператора с реквизитами

---

## 📄 Структура страниц и компонентов

### **1. Главная страница оператора - Dashboard** (`/dashboard`)

**Что показывается:**
- Текущая активная смена (если есть)
  - Время начала
  - Длительность в реальном времени
  - Площадка
  - Сумма выведенных средств за смену
  - Количество операций
- **Кнопка "Получить реквизит"** (главная CTA) - большая, заметная
- Быстрая статистика оператора за сегодня/за смену
- История последних операций (5-10 последних)

**Условия доступа:**
- Кнопка "Получить реквизит" активна ТОЛЬКО если:
  - ✅ Есть активная смена
  - ✅ Оператор залогинен
  - ❌ Если нет активной смены → показать "Сначала начните смену"

---

### **2. Модальное окно "Получить реквизит"**

**Триггер:** Клик на кнопку "Получить реквизит"

**Шаг 1 - Получение реквизита:**

```
┌────────────────────────────────────────┐
│   Получение реквизита для вывода      │
├────────────────────────────────────────┤
│                                        │
│  [Загрузка...]                        │
│  Подбираем оптимальный реквизит...    │
│                                        │
│  [Кнопка: Получить реквизит]          │
│                                        │
└────────────────────────────────────────┘
```

**API запрос:** `GET /bank-accounts/available`

**Логика на бэкенде:**
1. Получить userId оператора из JWT токена
2. Проверить, что у него есть активная смена
3. Выбрать реквизит по критериям:
   - `status = 'working'` (не "blocked", не "not_working")
   - `availableAmount > 0` (limitAmount - withdrawnAmount > 0)
   - `userId = currentUser.id` (привязан к этому оператору)
   - Сортировка: `ORDER BY priority DESC, lastUsedAt ASC NULLS FIRST`
4. Вернуть реквизит ИЛИ ошибку "Нет доступных реквизитов"

**Ответ API:**
```json
{
  "id": "uuid",
  "bank": { "name": "Banco Galicia" },
  "cbu": "0070012312345678901234",
  "alias": "crypto.port.arg",
  "accountType": "personal",
  "availableAmount": 150000,
  "limitAmount": 200000,
  "withdrawnAmount": 50000,
  "priority": 5
}
```

---

**Шаг 2 - Отображение реквизита:**

```
┌────────────────────────────────────────┐
│   Реквизит для вывода                 │
├────────────────────────────────────────┤
│                                        │
│  🏦 Банк: Banco Galicia               │
│                                        │
│  📋 CBU: 0070012312345678901234       │
│     [Копировать]                      │
│                                        │
│  🔖 Alias: crypto.port.arg            │
│     [Копировать]                      │
│                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                        │
│  💰 Доступно для вывода:              │
│     ARS 150,000                       │
│                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                        │
│  Выполните перевод вручную            │
│  и введите фактическую сумму          │
│                                        │
│  [Далее - Ввести сумму] →             │
│                                        │
└────────────────────────────────────────┘
```

**Функционал:**
- Кнопки "Копировать" для CBU и Alias
- Показать доступный лимит
- Предупреждение если лимит < 50000 (близко к исчерпанию)
- Кнопка "Далее" → переход к форме ввода суммы

---

**Шаг 3 - Ввод суммы вывода:**

```
┌────────────────────────────────────────┐
│   Введите сумму вывода                │
├────────────────────────────────────────┤
│                                        │
│  Реквизит: Banco Galicia              │
│  CBU: ...1234 | Alias: crypto.port... │
│                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                        │
│  Фактическая сумма вывода: *          │
│  ┌──────────────────────────────────┐ │
│  │  50000                           │ │
│  └──────────────────────────────────┘ │
│  Доступно: ARS 150,000                │
│                                        │
│  Комментарий (опционально):           │
│  ┌──────────────────────────────────┐ │
│  │                                  │ │
│  └──────────────────────────────────┘ │
│                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                        │
│  [Отмена]  [Подтвердить вывод] ✓     │
│                                        │
└────────────────────────────────────────┘
```

**Валидация:**
- ✅ Сумма > 0
- ✅ Сумма ≤ availableAmount
- ✅ Сумма в разумных пределах (например, не 0.01)

**API запрос:** `POST /transactions`

**Тело запроса:**
```json
{
  "bankAccountId": "uuid-реквизита",
  "amount": 50000,
  "comment": "Необязательный комментарий",
  "shiftId": "uuid-текущей-смены"
}
```

**Логика на бэкенде:**
1. Проверить, что реквизит всё ещё доступен
2. Проверить, что сумма ≤ availableAmount
3. Создать транзакцию:
   ```sql
   INSERT INTO transactions (
     bankAccountId, 
     operatorId, 
     shiftId, 
     amount, 
     type, 
     status, 
     comment
   ) VALUES (?, ?, ?, ?, 'withdrawal', 'completed', ?)
   ```
4. Обновить реквизит:
   ```sql
   UPDATE bank_accounts 
   SET 
     withdrawnAmount = withdrawnAmount + ?,
     lastUsedAt = NOW()
   WHERE id = ?
   ```
5. Проверить лимит:
   ```javascript
   if (withdrawnAmount >= limitAmount) {
     // Автоблокировка
     UPDATE bank_accounts 
     SET 
       status = 'blocked',
       blockReason = 'Достигнут лимит вывода'
     WHERE id = ?
   }
   ```
6. Обновить статистику смены:
   ```sql
   UPDATE shifts 
   SET 
     totalAmount = totalAmount + ?,
     operationsCount = operationsCount + 1
   WHERE id = ?
   ```

**Ответ API:**
```json
{
  "transaction": {
    "id": "uuid",
    "amount": 50000,
    "bankAccount": {...},
    "shift": {...},
    "createdAt": "2025-12-25T18:00:00Z"
  },
  "updatedBankAccount": {
    "withdrawnAmount": 100000,
    "availableAmount": 100000,
    "status": "working"
  }
}
```

---

**Шаг 4 - Успешное подтверждение:**

```
┌────────────────────────────────────────┐
│   ✅ Операция выполнена успешно       │
├────────────────────────────────────────┤
│                                        │
│  Сумма вывода: ARS 50,000             │
│  Реквизит: Banco Galicia              │
│  Время: 18:00:00                      │
│                                        │
│  Остаток на реквизите: ARS 100,000    │
│                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                        │
│  За эту смену:                        │
│  💰 ARS 150,000 (3 операции)         │
│                                        │
│  [Получить следующий реквизит] →      │
│  [Закрыть]                            │
│                                        │
└────────────────────────────────────────┘
```

---

## 🗂️ Страница "Мои операции" (`/my-transactions`)

**Для оператора - только его транзакции:**

```
╔════════════════════════════════════════╗
║  Мои операции                         ║
╠════════════════════════════════════════╣
║  [Поиск] [Фильтр: За сегодня ▼]      ║
║                                        ║
║  ┌────────────────────────────────┐   ║
║  │ 25 дек 2025, 18:00            │   ║
║  │ Banco Galicia • ...1234       │   ║
║  │ ARS 50,000                    │   ║
║  │ Смена: Binance (3ч 25м)       │   ║
║  └────────────────────────────────┘   ║
║                                        ║
║  ┌────────────────────────────────┐   ║
║  │ 25 дек 2025, 17:30            │   ║
║  │ Banco Nación • ...5678        │   ║
║  │ ARS 75,000                    │   ║
║  │ Смена: Binance (2ч 55м)       │   ║
║  └────────────────────────────────┘   ║
║                                        ║
╚════════════════════════════════════════╝
```

**Показывать:**
- Дата и время
- Банк и частичный CBU
- Сумма
- Смена (название площадки + длительность на момент операции)
- Комментарий (если был)

---

## 📊 Обновление Dashboard после операции

После успешной операции Dashboard должен обновиться автоматически:
- ✅ Общая сумма за смену: +50,000
- ✅ Количество операций: +1
- ✅ Последние операции: добавлена новая в топ списка

---

## 🔒 Защиты и ограничения

### **Frontend:**
1. Кнопка "Получить реквизит" disabled если:
   - Нет активной смены
   - Идёт загрузка
   - Уже получен реквизит (до завершения операции)

2. Форма ввода суммы:
   - Валидация на клиенте
   - Нельзя ввести больше availableAmount
   - Нельзя отправить пустую форму

### **Backend:**
1. JWT авторизация на всех эндпоинтах
2. Проверка роли: только OPERATOR может получать реквизиты
3. Проверка активной смены
4. Проверка доступности реквизита
5. Transaction на уровне БД для atomicity

---

## 🎨 UX детали

### **Анимации:**
- Плавное открытие модального окна
- Transition между шагами (слайд влево/вправо)
- Успешная операция - зелёная галочка с анимацией

### **Копирование:**
- Toast уведомление "CBU скопирован"
- Иконка меняется на галочку на 2 секунды

### **Ошибки:**
- Красный toast если нет доступных реквизитов
- Подсказка "Обратитесь к администратору"

---

## 📁 Структура файлов

```
frontend/src/
├── pages/
│   ├── Dashboard/
│   │   ├── Dashboard.tsx           # Главная страница оператора
│   │   └── Dashboard.css
│   ├── Transactions/
│   │   ├── MyTransactions.tsx      # История операций
│   │   └── MyTransactions.css
├── components/
│   ├── GetRequisiteModal/
│   │   ├── GetRequisiteModal.tsx   # Модалка получения реквизита
│   │   ├── RequisiteDisplay.tsx    # Шаг 2: показ реквизита
│   │   ├── AmountForm.tsx          # Шаг 3: форма ввода суммы
│   │   ├── SuccessMessage.tsx      # Шаг 4: успех
│   │   └── GetRequisiteModal.css
├── services/
│   └── transactions.service.ts     # API для транзакций
```

---

## 🔌 Необходимые API эндпоинты

### **1. GET /bank-accounts/available**
- Получить доступный реквизит для оператора
- Авторизация: JWT (operator)
- Логика приоритетов

**Response:**
```typescript
{
  id: string;
  bank: { name: string };
  cbu: string;
  alias: string;
  accountType: string;
  availableAmount: number;
  limitAmount: number;
  withdrawnAmount: number;
  priority: number;
}
```

---

### **2. POST /transactions**
- Создать транзакцию вывода
- Обновить реквизит
- Обновить смену
- Проверить и заблокировать при лимите

**Request:**
```typescript
{
  bankAccountId: string;
  amount: number;
  comment?: string;
  shiftId: string;
}
```

**Response:**
```typescript
{
  transaction: {
    id: string;
    amount: number;
    bankAccount: BankAccount;
    shift: Shift;
    createdAt: string;
  };
  updatedBankAccount: {
    withdrawnAmount: number;
    availableAmount: number;
    status: string;
  };
}
```

---

### **3. GET /transactions/my**
- Получить историю операций текущего оператора
- Фильтры: дата, смена
- Pagination

**Query params:**
```typescript
{
  page?: number;
  limit?: number;
  shiftId?: string;
  dateFrom?: string;
  dateTo?: string;
}
```

**Response:**
```typescript
{
  items: Transaction[];
  total: number;
}
```

---

## 🔄 Типичный workflow оператора

```
1. Логин в систему
2. Переход на Dashboard
3. Начать смену (выбрать площадку)
4. Цикл работы:
   ├─ Нажать "Получить реквизит"
   ├─ Скопировать CBU/Alias
   ├─ Выполнить вывод вручную (в банковском приложении)
   ├─ Ввести фактическую сумму вывода
   ├─ Подтвердить
   └─ Повторить
5. Завершить смену
6. Посмотреть статистику за смену
```

---

## ✅ Критерии готовности

- [ ] Dashboard показывает активную смену
- [ ] Кнопка "Получить реквизит" активна только при активной смене
- [ ] API GET /bank-accounts/available работает
- [ ] Модальное окно открывается и показывает реквизит
- [ ] Кнопки копирования работают
- [ ] Форма ввода суммы валидируется
- [ ] API POST /transactions создаёт транзакцию
- [ ] Реквизит обновляется (withdrawnAmount)
- [ ] Смена обновляется (totalAmount, operationsCount)
- [ ] Автоблокировка при достижении лимита
- [ ] Dashboard обновляется после операции
- [ ] Страница "Мои операции" показывает историю
- [ ] Все ошибки обрабатываются корректно
